# 權限系統設計

## 權限架構概述

本系統採用 RBAC (Role-Based Access Control) 角色權限控制模型。

---

## 權限層級定義

### 三種權限層級

| 層級 | 角色代碼 | 角色名稱 | 說明 | 可授權對象 |
|------|----------|----------|------|------------|
| 1 | admin | 最大管理者 | 開發者使用 | host |
| 2 | host | 使用者管理者 | 客戶最高權限 | user |
| 3 | user | 使用者 | 一般管理者 | - |

### 授權規則

```
admin (層級 1) ───→ 可授權給 host (層級 2)
                    │
                    ↓
              host (層級 2) ───→ 可授權給 user (層級 3) 
                                 (僅限自己擁有的權限)
                                │
                                ↓
                          user (層級 3) ───→ 無法授權
```

---

## 權限模型 (Model)

### RoleModel

**檔案位置**: `app/Models/Role.php`

```php
<?php
namespace App\Models;

use Core\Model;
use Core\Database;

class Role extends Model
{
    protected $table = 'AcRoles';
    protected $fillable = [
        'role_code',
        'role_name',
        'level',
        'description',
        'can_assign_to',
        'status'
    ];
    
    /**
     * 取得角色的所有功能權限
     */
    public function getFunctions($roleId)
    {
        $sql = "SELECT f.*, rf.can_view, rf.can_create, rf.can_edit, rf.can_delete
                FROM AcFunctions f
                INNER JOIN AcRoleFunctions rf ON f.id = rf.function_id
                WHERE rf.role_id = :role_id AND f.status = 1
                ORDER BY f.sort_order";
        
        return $this->db->query($sql, ['role_id' => $roleId])->fetchAll();
    }
    
    /**
     * 設定角色功能權限
     */
    public function setFunctions($roleId, array $functions)
    {
        $this->db->beginTransaction();
        
        try {
            // 先刪除現有權限
            $this->db->query(
                "DELETE FROM AcRoleFunctions WHERE role_id = :role_id",
                ['role_id' => $roleId]
            );
            
            // 新增權限
            foreach ($functions as $func) {
                $this->db->query(
                    "INSERT INTO AcRoleFunctions 
                     (role_id, function_id, can_view, can_create, can_edit, can_delete)
                     VALUES (:role_id, :function_id, :can_view, :can_create, :can_edit, :can_delete)",
                    [
                        'role_id' => $roleId,
                        'function_id' => $func['function_id'],
                        'can_view' => $func['can_view'] ?? 1,
                        'can_create' => $func['can_create'] ?? 0,
                        'can_edit' => $func['can_edit'] ?? 0,
                        'can_delete' => $func['can_delete'] ?? 0,
                    ]
                );
            }
            
            $this->db->commit();
            return true;
        } catch (\Exception $e) {
            $this->db->rollBack();
            throw $e;
        }
    }
    
    /**
     * 取得可授權的角色
     * 
     * @param int $currentLevel 目前使用者的權限層級
     */
    public function getAssignableRoles($currentLevel)
    {
        $sql = "SELECT * FROM AcRoles 
                WHERE level > :level AND status = 1
                ORDER BY level";
        
        return $this->db->query($sql, ['level' => $currentLevel])->fetchAll();
    }
    
    /**
     * 檢查是否可以授權特定角色
     */
    public function canAssignRole($assignerLevel, $roleId)
    {
        $role = $this->find($roleId);
        
        if (!$role) {
            return false;
        }
        
        // 只能授權比自己層級低的角色
        return $role['level'] > $assignerLevel;
    }
}
```

### UserModel

**檔案位置**: `app/Models/User.php`

```php
<?php
namespace App\Models;

use Core\Model;

class User extends Model
{
    protected $table = 'AcUsers';
    protected $fillable = [
        'username',
        'email',
        'password',
        'display_name',
        'phone',
        'avatar',
        'status',
        'created_by'
    ];
    
    /**
     * 依帳號查詢
     */
    public function findByUsername($username)
    {
        return $this->findBy('username', $username);
    }
    
    /**
     * 依 Email 查詢
     */
    public function findByEmail($email)
    {
        return $this->findBy('email', $email);
    }
    
    /**
     * 取得使用者的所有角色
     */
    public function getRoles($userId)
    {
        $sql = "SELECT r.* FROM AcRoles r
                INNER JOIN AcUserRoles ur ON r.id = ur.role_id
                WHERE ur.user_id = :user_id AND r.status = 1
                ORDER BY r.level";
        
        return $this->db->query($sql, ['user_id' => $userId])->fetchAll();
    }
    
    /**
     * 取得使用者最高權限層級
     */
    public function getHighestLevel($userId)
    {
        $sql = "SELECT MIN(r.level) as level FROM AcRoles r
                INNER JOIN AcUserRoles ur ON r.id = ur.role_id
                WHERE ur.user_id = :user_id AND r.status = 1";
        
        $result = $this->db->query($sql, ['user_id' => $userId])->fetch();
        
        return $result['level'] ?? 999;
    }
    
    /**
     * 取得使用者所有功能權限
     */
    public function getPermissions($userId)
    {
        $sql = "SELECT 
                    f.function_code,
                    f.function_name,
                    f.url,
                    MAX(rf.can_view) as can_view,
                    MAX(rf.can_create) as can_create,
                    MAX(rf.can_edit) as can_edit,
                    MAX(rf.can_delete) as can_delete
                FROM AcFunctions f
                INNER JOIN AcRoleFunctions rf ON f.id = rf.function_id
                INNER JOIN AcUserRoles ur ON rf.role_id = ur.role_id
                WHERE ur.user_id = :user_id AND f.status = 1
                GROUP BY f.id, f.function_code, f.function_name, f.url";
        
        $permissions = $this->db->query($sql, ['user_id' => $userId])->fetchAll();
        
        // 轉換為以 function_code 為 key 的陣列
        $result = [];
        foreach ($permissions as $perm) {
            $result[$perm['function_code']] = [
                'function_name' => $perm['function_name'],
                'url' => $perm['url'],
                'can_view' => (bool) $perm['can_view'],
                'can_create' => (bool) $perm['can_create'],
                'can_edit' => (bool) $perm['can_edit'],
                'can_delete' => (bool) $perm['can_delete'],
            ];
        }
        
        return $result;
    }
    
    /**
     * 指派角色給使用者
     */
    public function assignRole($userId, $roleId, $assignedBy = null)
    {
        $sql = "INSERT IGNORE INTO AcUserRoles (user_id, role_id, assigned_by)
                VALUES (:user_id, :role_id, :assigned_by)";
        
        return $this->db->query($sql, [
            'user_id' => $userId,
            'role_id' => $roleId,
            'assigned_by' => $assignedBy
        ]);
    }
    
    /**
     * 移除使用者角色
     */
    public function removeRole($userId, $roleId)
    {
        $sql = "DELETE FROM AcUserRoles WHERE user_id = :user_id AND role_id = :role_id";
        return $this->db->query($sql, [
            'user_id' => $userId,
            'role_id' => $roleId
        ]);
    }
    
    /**
     * 設定使用者角色 (取代所有現有角色)
     */
    public function setRoles($userId, array $roleIds, $assignedBy = null)
    {
        $this->db->beginTransaction();
        
        try {
            // 刪除現有角色
            $this->db->query(
                "DELETE FROM AcUserRoles WHERE user_id = :user_id",
                ['user_id' => $userId]
            );
            
            // 指派新角色
            foreach ($roleIds as $roleId) {
                $this->assignRole($userId, $roleId, $assignedBy);
            }
            
            $this->db->commit();
            return true;
        } catch (\Exception $e) {
            $this->db->rollBack();
            throw $e;
        }
    }
    
    /**
     * 取得可管理的使用者 (依權限層級)
     */
    public function getManagedUsers($managerLevel)
    {
        $sql = "SELECT u.*, MIN(r.level) as user_level
                FROM AcUsers u
                LEFT JOIN AcUserRoles ur ON u.id = ur.user_id
                LEFT JOIN AcRoles r ON ur.role_id = r.id
                GROUP BY u.id
                HAVING user_level > :level OR user_level IS NULL
                ORDER BY u.created_at DESC";
        
        return $this->db->query($sql, ['level' => $managerLevel])->fetchAll();
    }
}
```

---

## 權限中介層 (Middleware)

### AuthMiddleware (登入驗證)

**檔案位置**: `app/Middleware/AuthMiddleware.php`

```php
<?php
namespace App\Middleware;

class AuthMiddleware
{
    /**
     * 處理中介層
     */
    public function handle()
    {
        // 檢查是否已登入
        if (!isset($_SESSION['user']) || empty($_SESSION['user']['id'])) {
            // 儲存原本要訪問的網址
            $_SESSION['redirect_url'] = $_SERVER['REQUEST_URI'];
            
            header('Location: /account/login');
            exit;
        }
        
        // 檢查帳號狀態
        if ($_SESSION['user']['status'] != 1) {
            session_destroy();
            header('Location: /account/login?error=disabled');
            exit;
        }
    }
}
```

### RoleMiddleware (權限驗證)

**檔案位置**: `app/Middleware/RoleMiddleware.php`

```php
<?php
namespace App\Middleware;

class RoleMiddleware
{
    protected $requiredLevel;
    protected $requiredFunction;
    protected $requiredAction;
    
    /**
     * 建構式
     * 
     * @param int $level 最低權限層級
     * @param string|null $function 功能代碼
     * @param string $action 操作類型
     */
    public function __construct($level = 3, $function = null, $action = 'view')
    {
        $this->requiredLevel = $level;
        $this->requiredFunction = $function;
        $this->requiredAction = $action;
    }
    
    /**
     * 處理中介層
     */
    public function handle()
    {
        $user = $_SESSION['user'] ?? null;
        
        if (!$user) {
            $this->forbidden();
        }
        
        // 檢查權限層級
        $userLevel = $user['level'] ?? 999;
        
        if ($userLevel > $this->requiredLevel) {
            $this->forbidden();
        }
        
        // 檢查功能權限
        if ($this->requiredFunction) {
            $permissions = $_SESSION['permissions'] ?? [];
            
            if (!isset($permissions[$this->requiredFunction])) {
                $this->forbidden();
            }
            
            $actionMap = [
                'view' => 'can_view',
                'create' => 'can_create',
                'edit' => 'can_edit',
                'delete' => 'can_delete'
            ];
            
            $permKey = $actionMap[$this->requiredAction] ?? 'can_view';
            
            if (!($permissions[$this->requiredFunction][$permKey] ?? false)) {
                $this->forbidden();
            }
        }
    }
    
    /**
     * 禁止存取
     */
    protected function forbidden()
    {
        http_response_code(403);
        include ROOT_PATH . '/app/Views/errors/403.php';
        exit;
    }
}
```

---

## 權限服務 (Service)

### PermissionService

**檔案位置**: `app/Services/PermissionService.php`

```php
<?php
namespace App\Services;

use App\Models\User;
use App\Models\Role;

class PermissionService
{
    protected $userModel;
    protected $roleModel;
    
    public function __construct()
    {
        $this->userModel = new User();
        $this->roleModel = new Role();
    }
    
    /**
     * 載入使用者權限到 Session
     */
    public function loadUserPermissions($userId)
    {
        // 取得使用者權限層級
        $level = $this->userModel->getHighestLevel($userId);
        
        // 取得功能權限
        $permissions = $this->userModel->getPermissions($userId);
        
        // 取得選單
        $menu = $this->buildUserMenu($userId, $level);
        
        // 儲存到 Session
        $_SESSION['user']['level'] = $level;
        $_SESSION['permissions'] = $permissions;
        $_SESSION['menu'] = $menu;
        
        return [
            'level' => $level,
            'permissions' => $permissions,
            'menu' => $menu
        ];
    }
    
    /**
     * 建構使用者選單
     */
    public function buildUserMenu($userId, $level)
    {
        $db = \Core\Database::getInstance();
        
        // 取得使用者有權限的功能
        $sql = "SELECT DISTINCT f.*
                FROM AcFunctions f
                INNER JOIN AcRoleFunctions rf ON f.id = rf.function_id
                INNER JOIN AcUserRoles ur ON rf.role_id = ur.role_id
                WHERE ur.user_id = :user_id 
                  AND f.status = 1 
                  AND f.is_menu = 1
                  AND f.min_level >= :level
                  AND rf.can_view = 1
                ORDER BY f.sort_order";
        
        $functions = $db->query($sql, [
            'user_id' => $userId,
            'level' => $level
        ])->fetchAll();
        
        // 建構階層選單
        return $this->buildMenuTree($functions);
    }
    
    /**
     * 建構選單樹狀結構
     */
    protected function buildMenuTree(array $items, $parentId = null)
    {
        $tree = [];
        
        foreach ($items as $item) {
            if ($item['parent_id'] == $parentId) {
                $children = $this->buildMenuTree($items, $item['id']);
                
                if ($children) {
                    $item['children'] = $children;
                }
                
                $tree[] = $item;
            }
        }
        
        return $tree;
    }
    
    /**
     * 檢查使用者是否有權限執行操作
     */
    public function checkPermission($userId, $functionCode, $action = 'view')
    {
        $permissions = $this->userModel->getPermissions($userId);
        
        if (!isset($permissions[$functionCode])) {
            return false;
        }
        
        $actionMap = [
            'view' => 'can_view',
            'create' => 'can_create',
            'edit' => 'can_edit',
            'delete' => 'can_delete'
        ];
        
        $permKey = $actionMap[$action] ?? 'can_view';
        
        return $permissions[$functionCode][$permKey] ?? false;
    }
    
    /**
     * 檢查授權者是否可以授權特定角色給目標使用者
     */
    public function canAssignRole($assignerId, $roleId, $targetUserId = null)
    {
        // 取得授權者層級
        $assignerLevel = $this->userModel->getHighestLevel($assignerId);
        
        // 檢查角色是否可被授權
        $role = $this->roleModel->find($roleId);
        
        if (!$role) {
            return false;
        }
        
        // 只能授權比自己層級低的角色
        if ($role['level'] <= $assignerLevel) {
            return false;
        }
        
        // 如果是 host 授權給 user，檢查 host 是否擁有該角色的功能權限
        if ($assignerLevel == 2 && $targetUserId) {
            $assignerFunctions = $this->userModel->getPermissions($assignerId);
            $roleFunctions = $this->roleModel->getFunctions($roleId);
            
            foreach ($roleFunctions as $func) {
                if (!isset($assignerFunctions[$func['function_code']])) {
                    return false; // host 沒有這個功能的權限
                }
            }
        }
        
        return true;
    }
    
    /**
     * 取得授權者可授權的角色清單
     */
    public function getAssignableRoles($assignerId)
    {
        $assignerLevel = $this->userModel->getHighestLevel($assignerId);
        
        return $this->roleModel->getAssignableRoles($assignerLevel);
    }
}
```

---

## 權限檢查輔助函式

**檔案位置**: `app/Helpers/functions.php`

```php
<?php
/**
 * 檢查是否已登入
 */
function is_logged_in()
{
    return isset($_SESSION['user']) && !empty($_SESSION['user']['id']);
}

/**
 * 取得目前使用者
 */
function current_user()
{
    return $_SESSION['user'] ?? null;
}

/**
 * 取得目前使用者 ID
 */
function current_user_id()
{
    return $_SESSION['user']['id'] ?? null;
}

/**
 * 檢查權限層級
 */
function has_level($requiredLevel)
{
    $userLevel = $_SESSION['user']['level'] ?? 999;
    return $userLevel <= $requiredLevel;
}

/**
 * 檢查功能權限
 */
function has_permission($functionCode, $action = 'view')
{
    $permissions = $_SESSION['permissions'] ?? [];
    
    if (!isset($permissions[$functionCode])) {
        return false;
    }
    
    $actionMap = [
        'view' => 'can_view',
        'create' => 'can_create',
        'edit' => 'can_edit',
        'delete' => 'can_delete'
    ];
    
    $permKey = $actionMap[$action] ?? 'can_view';
    
    return $permissions[$functionCode][$permKey] ?? false;
}

/**
 * 是否為管理者
 */
function is_admin()
{
    return has_level(1);
}

/**
 * 是否為使用者管理者
 */
function is_host()
{
    return has_level(2);
}

/**
 * 取得選單
 */
function get_menu()
{
    return $_SESSION['menu'] ?? [];
}
```
