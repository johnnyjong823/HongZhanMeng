# cPanel + FTP 部署指南

## 部署前準備

### 1. 確認主機環境

登入 cPanel 後，確認以下設定：

| 項目 | 位置 | 需求 |
|------|------|------|
| PHP 版本 | cPanel > Select PHP Version | 8.0 以上 |
| PHP 擴充套件 | cPanel > Select PHP Version > Extensions | pdo_mysql, mbstring, openssl, json |
| MySQL | cPanel > MySQL Databases | 可建立資料庫 |
| FTP | cPanel > FTP Accounts | 可建立 FTP 帳號 |

### 2. PHP 版本設定

1. 登入 cPanel
2. 找到「Software」區塊
3. 點擊「Select PHP Version」
4. 選擇 PHP 8.0 或更高版本
5. 勾選必要擴充套件：
   - `pdo_mysql`
   - `mbstring`
   - `openssl`
   - `json`
   - `session`
   - `fileinfo`
6. 點擊「Save」

---

## 資料庫設定

### 1. 建立資料庫

1. 在 cPanel 找到「Databases」區塊
2. 點擊「MySQL Databases」
3. 建立新資料庫：
   - 輸入資料庫名稱（例如：`hzm_db`）
   - 點擊「Create Database」

### 2. 建立資料庫使用者

1. 在同一頁面，找到「Add New User」
2. 輸入使用者名稱和密碼
3. 點擊「Create User」

### 3. 設定使用者權限

1. 在「Add User To Database」區塊
2. 選擇剛建立的使用者和資料庫
3. 點擊「Add」
4. 勾選「ALL PRIVILEGES」
5. 點擊「Make Changes」

### 4. 匯入資料庫結構

1. 進入 cPanel > phpMyAdmin
2. 選擇剛建立的資料庫
3. 點擊「Import」
4. 上傳 `database/migrations/` 中的 SQL 檔案
5. 依序執行

---

## 檔案上傳

### 方法一：使用 cPanel 檔案管理員

1. 在 cPanel 找到「Files」區塊
2. 點擊「File Manager」
3. 進入 `public_html` 目錄
4. 上傳專案檔案

### 方法二：使用 FTP

#### FTP 帳號設定

1. 在 cPanel > FTP Accounts
2. 建立新 FTP 帳號
3. 設定目錄為 `/public_html`

#### FTP 軟體設定 (FileZilla)

```
主機: ftp.your-domain.com
使用者名稱: your-ftp-user@your-domain.com
密碼: your-password
連接埠: 21
```

### 上傳目錄結構

```
public_html/                  # 網站根目錄
├── app/                     # 應用程式
├── core/                    # 框架核心
├── config/                  # 設定檔
├── database/                # 資料庫檔案
├── storage/                 # 儲存目錄 (需設定權限)
├── public/                  # 公開目錄
│   ├── index.php           # 入口檔案
│   ├── .htaccess           # URL 重寫
│   └── assets/             # 靜態資源
├── .htaccess               # 根目錄重寫
└── ...
```

---

## 設定檔調整

### 1. 資料庫設定

**檔案**: `config/database.php`

```php
<?php
return [
    'host' => 'localhost',           // cPanel 通常是 localhost
    'port' => '3306',
    'database' => 'your_cpanel_username_hzm_db',  // cPanel 會加上前綴
    'username' => 'your_cpanel_username_dbuser',  // cPanel 會加上前綴
    'password' => 'your-database-password',
    'charset' => 'utf8mb4',
];
```

### 2. 應用程式設定

**檔案**: `config/app.php`

```php
<?php
return [
    'name' => '鴻展盟管理系統',
    'debug' => false,                          // 正式環境設為 false
    'url' => 'https://your-domain.com',        // 改為實際網址
    
    'session' => [
        'lifetime' => 3600,
        'path' => '/',
        'domain' => null,
        'secure' => true,    // 如果使用 HTTPS
        'httponly' => true,
        'samesite' => 'Lax',
    ],
    
    'auth' => [
        'max_attempts' => 5,
        'lockout_time' => 900,
        'password_min_length' => 8,
    ],
];
```

### 3. 郵件設定

**檔案**: `config/mail.php`

```php
<?php
return [
    // cPanel 通常使用主機的郵件服務
    'from_email' => 'noreply@your-domain.com',
    'from_name' => '鴻展盟管理系統',
];
```

---

## 目錄權限設定

使用 cPanel 檔案管理員或 FTP 設定權限：

```
storage/          → 755 或 775
storage/logs/     → 755 或 775
storage/cache/    → 755 或 775
storage/sessions/ → 755 或 775
public/uploads/   → 755 或 775
```

### cPanel 設定方式

1. File Manager 中選擇目錄
2. 點擊「Permissions」
3. 設定為 755 (rwxr-xr-x)

### FTP 設定方式 (FileZilla)

1. 右鍵點擊目錄
2. 選擇「File permissions」
3. 輸入 755
4. 勾選「Recurse into subdirectories」

---

## URL 重寫設定

### 確認 mod_rewrite 已啟用

大多數 cPanel 主機預設已啟用。如果遇到問題，請聯繫主機商。

### 根目錄 .htaccess

**檔案**: `public_html/.htaccess`

```apache
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # 將所有請求導向 public 目錄
    RewriteCond %{REQUEST_URI} !^/public/
    RewriteRule ^(.*)$ public/$1 [L]
</IfModule>

# 禁止目錄瀏覽
Options -Indexes

# 禁止存取敏感檔案
<FilesMatch "^\.">
    Require all denied
</FilesMatch>
```

### Public 目錄 .htaccess

**檔案**: `public_html/public/.htaccess`

```apache
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /
    
    # 如果是真實檔案或目錄，直接存取
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    
    # 其他請求導向 index.php
    RewriteRule ^(.*)$ index.php?url=$1 [QSA,L]
</IfModule>

# PHP 設定
<IfModule mod_php.c>
    php_value upload_max_filesize 64M
    php_value post_max_size 64M
    php_value max_execution_time 120
    php_value memory_limit 256M
</IfModule>

# 安全性標頭
<IfModule mod_headers.c>
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "SAMEORIGIN"
    Header set X-XSS-Protection "1; mode=block"
</IfModule>
```

---

## SSL 憑證設定

### 使用 cPanel 免費 SSL (Let's Encrypt)

1. 在 cPanel 找到「Security」區塊
2. 點擊「SSL/TLS Status」或「Let's Encrypt SSL」
3. 選擇網域
4. 點擊「Issue」或「Install」

### 強制 HTTPS

在 `.htaccess` 加入：

```apache
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</IfModule>
```

---

## 部署檢查清單

### 上傳前

- [ ] 修改 `config/database.php` 為正式環境設定
- [ ] 修改 `config/app.php` 設定 `debug => false`
- [ ] 修改 `config/app.php` 設定正確的 URL
- [ ] 確認 `.htaccess` 檔案已包含

### 上傳後

- [ ] 設定目錄權限 (storage, uploads)
- [ ] 匯入資料庫結構
- [ ] 執行種子資料 (建立預設管理員)
- [ ] 測試首頁是否正常
- [ ] 測試登入功能
- [ ] 測試 Session 逾時
- [ ] 確認 SSL 已啟用

### 安全性檢查

- [ ] 關閉 PHP 錯誤顯示
- [ ] 確認敏感檔案無法存取
- [ ] 測試登入失敗鎖定功能
- [ ] 確認密碼為加密儲存

---

## 常見問題排除

### 1. 頁面顯示 500 錯誤

**可能原因**：
- `.htaccess` 語法錯誤
- PHP 版本不相容
- 檔案權限問題

**解決方法**：
1. 檢查 cPanel > Error Log
2. 暫時移除 `.htaccess` 測試
3. 確認 PHP 版本為 8.0+

### 2. 資料庫連線失敗

**可能原因**：
- 帳號密碼錯誤
- 資料庫名稱前綴問題

**解決方法**：
1. 確認 cPanel 資料庫名稱（通常有前綴）
2. 確認資料庫使用者已授權

### 3. Session 無法儲存

**可能原因**：
- `storage/sessions` 目錄權限不足

**解決方法**：
1. 設定目錄權限為 755 或 775
2. 或使用資料庫儲存 Session

### 4. 郵件無法發送

**可能原因**：
- cPanel 郵件服務限制

**解決方法**：
1. 使用 cPanel 的 MX 記錄設定
2. 或使用第三方 SMTP 服務

### 5. 中文亂碼

**解決方法**：
1. 確認資料庫字元集為 `utf8mb4`
2. 確認 PHP 輸出有設定 `header('Content-Type: text/html; charset=utf-8')`

---

## 維護建議

### 定期備份

1. 使用 cPanel > Backup 功能
2. 定期下載資料庫備份
3. 定期下載檔案備份

### 日誌清理

定期清理 `storage/logs/` 中的舊日誌檔案

### 安全性更新

定期檢查是否有安全性更新需要套用
