# 密碼管理功能

## 功能概述

密碼管理包含：
1. **修改密碼**: 登入後修改自己的密碼
2. **忘記密碼**: 透過 Email 重設密碼

---

## 密碼服務

### PasswordService

**檔案位置**: `app/Services/PasswordService.php`

```php
<?php
namespace App\Services;

use App\Models\User;
use App\Services\MailService;

class PasswordService
{
    protected $userModel;
    protected $mailService;
    protected $config;
    
    public function __construct()
    {
        $this->userModel = new User();
        $this->mailService = new MailService();
        $this->config = require ROOT_PATH . '/config/app.php';
    }
    
    /**
     * 修改密碼
     * 
     * @param int $userId 使用者 ID
     * @param string $currentPassword 目前密碼
     * @param string $newPassword 新密碼
     * @return array ['success' => bool, 'message' => string]
     */
    public function changePassword($userId, $currentPassword, $newPassword)
    {
        // 取得使用者
        $user = $this->userModel->find($userId);
        
        if (!$user) {
            return [
                'success' => false,
                'message' => '使用者不存在'
            ];
        }
        
        // 驗證目前密碼
        if (!password_verify($currentPassword, $user['password'])) {
            return [
                'success' => false,
                'message' => '目前密碼不正確'
            ];
        }
        
        // 驗證新密碼強度
        $validation = $this->validatePasswordStrength($newPassword);
        
        if (!$validation['valid']) {
            return [
                'success' => false,
                'message' => $validation['message']
            ];
        }
        
        // 檢查新密碼是否與舊密碼相同
        if (password_verify($newPassword, $user['password'])) {
            return [
                'success' => false,
                'message' => '新密碼不能與目前密碼相同'
            ];
        }
        
        // 更新密碼
        $hashedPassword = password_hash($newPassword, PASSWORD_BCRYPT, ['cost' => 10]);
        
        $this->userModel->update($userId, [
            'password' => $hashedPassword,
            'password_changed_at' => date('Y-m-d H:i:s')
        ]);
        
        return [
            'success' => true,
            'message' => '密碼已更新成功'
        ];
    }
    
    /**
     * 發送密碼重設連結
     * 
     * @param string $email Email
     * @return array ['success' => bool, 'message' => string]
     */
    public function sendResetLink($email)
    {
        // 驗證 Email 格式
        if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
            return [
                'success' => false,
                'message' => 'Email 格式不正確'
            ];
        }
        
        // 查詢使用者
        $user = $this->userModel->findByEmail($email);
        
        // 無論使用者是否存在，都顯示相同訊息 (防止帳號枚舉)
        if (!$user) {
            // 為了安全性，不透露帳號是否存在
            return [
                'success' => true,
                'message' => '如果此 Email 已註冊，將會收到密碼重設信件'
            ];
        }
        
        // 檢查帳號狀態
        if ($user['status'] != 1) {
            return [
                'success' => true,
                'message' => '如果此 Email 已註冊，將會收到密碼重設信件'
            ];
        }
        
        // 產生重設 Token
        $token = bin2hex(random_bytes(32));
        $hashedToken = hash('sha256', $token);
        $expiresAt = date('Y-m-d H:i:s', time() + 3600); // 1 小時後過期
        
        // 儲存 Token
        $this->userModel->update($user['id'], [
            'reset_token' => $hashedToken,
            'reset_token_expires_at' => $expiresAt
        ]);
        
        // 產生重設連結
        $baseUrl = $this->config['url'] ?? 'http://localhost';
        $resetUrl = "{$baseUrl}/account/reset-password?token={$token}&email={$email}";
        
        // 發送郵件
        $this->mailService->sendPasswordReset($user['email'], $user['display_name'] ?? $user['username'], $resetUrl);
        
        return [
            'success' => true,
            'message' => '如果此 Email 已註冊，將會收到密碼重設信件'
        ];
    }
    
    /**
     * 驗證重設 Token
     * 
     * @param string $email Email
     * @param string $token Token
     * @return array ['valid' => bool, 'user' => array|null, 'message' => string]
     */
    public function validateResetToken($email, $token)
    {
        // 查詢使用者
        $user = $this->userModel->findByEmail($email);
        
        if (!$user) {
            return [
                'valid' => false,
                'message' => '連結無效或已過期'
            ];
        }
        
        // 檢查 Token
        if (!$user['reset_token']) {
            return [
                'valid' => false,
                'message' => '連結無效或已過期'
            ];
        }
        
        // 驗證 Token
        $hashedToken = hash('sha256', $token);
        
        if (!hash_equals($user['reset_token'], $hashedToken)) {
            return [
                'valid' => false,
                'message' => '連結無效或已過期'
            ];
        }
        
        // 檢查是否過期
        if (strtotime($user['reset_token_expires_at']) < time()) {
            return [
                'valid' => false,
                'message' => '連結已過期，請重新申請'
            ];
        }
        
        return [
            'valid' => true,
            'user' => $user,
            'message' => ''
        ];
    }
    
    /**
     * 重設密碼
     * 
     * @param string $email Email
     * @param string $token Token
     * @param string $newPassword 新密碼
     * @return array ['success' => bool, 'message' => string]
     */
    public function resetPassword($email, $token, $newPassword)
    {
        // 驗證 Token
        $validation = $this->validateResetToken($email, $token);
        
        if (!$validation['valid']) {
            return [
                'success' => false,
                'message' => $validation['message']
            ];
        }
        
        $user = $validation['user'];
        
        // 驗證新密碼強度
        $strengthValidation = $this->validatePasswordStrength($newPassword);
        
        if (!$strengthValidation['valid']) {
            return [
                'success' => false,
                'message' => $strengthValidation['message']
            ];
        }
        
        // 更新密碼
        $hashedPassword = password_hash($newPassword, PASSWORD_BCRYPT, ['cost' => 10]);
        
        $this->userModel->update($user['id'], [
            'password' => $hashedPassword,
            'password_changed_at' => date('Y-m-d H:i:s'),
            'reset_token' => null,
            'reset_token_expires_at' => null,
            'login_attempts' => 0,
            'locked_until' => null
        ]);
        
        return [
            'success' => true,
            'message' => '密碼已重設成功，請使用新密碼登入'
        ];
    }
    
    /**
     * 驗證密碼強度
     * 
     * @param string $password 密碼
     * @return array ['valid' => bool, 'message' => string]
     */
    public function validatePasswordStrength($password)
    {
        $minLength = $this->config['auth']['password_min_length'] ?? 8;
        
        // 長度檢查
        if (strlen($password) < $minLength) {
            return [
                'valid' => false,
                'message' => "密碼長度至少需要 {$minLength} 個字元"
            ];
        }
        
        // 必須包含英文字母
        if (!preg_match('/[a-zA-Z]/', $password)) {
            return [
                'valid' => false,
                'message' => '密碼必須包含英文字母'
            ];
        }
        
        // 必須包含數字
        if (!preg_match('/[0-9]/', $password)) {
            return [
                'valid' => false,
                'message' => '密碼必須包含數字'
            ];
        }
        
        // 可選：必須包含特殊字元
        // if (!preg_match('/[!@#$%^&*(),.?":{}|<>]/', $password)) {
        //     return [
        //         'valid' => false,
        //         'message' => '密碼必須包含特殊字元'
        //     ];
        // }
        
        return [
            'valid' => true,
            'message' => ''
        ];
    }
    
    /**
     * 管理員重設使用者密碼
     * 
     * @param int $adminId 管理員 ID
     * @param int $userId 目標使用者 ID
     * @param string $newPassword 新密碼
     * @return array ['success' => bool, 'message' => string]
     */
    public function adminResetPassword($adminId, $userId, $newPassword)
    {
        // 取得管理員層級
        $adminLevel = $this->userModel->getHighestLevel($adminId);
        $userLevel = $this->userModel->getHighestLevel($userId);
        
        // 只能重設比自己層級低的使用者
        if ($userLevel <= $adminLevel) {
            return [
                'success' => false,
                'message' => '您沒有權限重設此使用者的密碼'
            ];
        }
        
        // 驗證新密碼強度
        $validation = $this->validatePasswordStrength($newPassword);
        
        if (!$validation['valid']) {
            return [
                'success' => false,
                'message' => $validation['message']
            ];
        }
        
        // 更新密碼
        $hashedPassword = password_hash($newPassword, PASSWORD_BCRYPT, ['cost' => 10]);
        
        $this->userModel->update($userId, [
            'password' => $hashedPassword,
            'password_changed_at' => date('Y-m-d H:i:s'),
            'login_attempts' => 0,
            'locked_until' => null
        ]);
        
        return [
            'success' => true,
            'message' => '密碼已重設成功'
        ];
    }
}
```

---

## 郵件服務

### MailService

**檔案位置**: `app/Services/MailService.php`

```php
<?php
namespace App\Services;

class MailService
{
    protected $config;
    
    public function __construct()
    {
        $this->config = require ROOT_PATH . '/config/mail.php';
    }
    
    /**
     * 發送密碼重設郵件
     */
    public function sendPasswordReset($email, $name, $resetUrl)
    {
        $subject = '密碼重設 - 鴻展盟管理系統';
        
        $body = $this->getPasswordResetTemplate($name, $resetUrl);
        
        return $this->send($email, $subject, $body);
    }
    
    /**
     * 發送郵件
     */
    public function send($to, $subject, $body, $isHtml = true)
    {
        $headers = [
            'MIME-Version: 1.0',
            'Content-Type: ' . ($isHtml ? 'text/html' : 'text/plain') . '; charset=UTF-8',
            'From: ' . $this->config['from_name'] . ' <' . $this->config['from_email'] . '>',
            'Reply-To: ' . $this->config['from_email'],
            'X-Mailer: PHP/' . phpversion()
        ];
        
        // 使用 PHP 內建 mail() 函式
        // 注意：cPanel 主機通常已設定好 sendmail
        $result = mail($to, $subject, $body, implode("\r\n", $headers));
        
        // 記錄郵件發送
        $this->logMail($to, $subject, $result);
        
        return $result;
    }
    
    /**
     * 密碼重設郵件模板
     */
    protected function getPasswordResetTemplate($name, $resetUrl)
    {
        return <<<HTML
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
</head>
<body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
    <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
        <h2 style="color: #667eea;">密碼重設</h2>
        
        <p>您好，{$name}</p>
        
        <p>我們收到了您的密碼重設請求。請點擊下方按鈕重設您的密碼：</p>
        
        <p style="text-align: center;">
            <a href="{$resetUrl}" 
               style="display: inline-block; padding: 12px 24px; 
                      background-color: #667eea; color: white; 
                      text-decoration: none; border-radius: 5px;
                      font-weight: bold;">
                重設密碼
            </a>
        </p>
        
        <p>如果按鈕無法點擊，請複製以下連結到瀏覽器：</p>
        <p style="word-break: break-all; color: #666;">
            <a href="{$resetUrl}">{$resetUrl}</a>
        </p>
        
        <p><strong>此連結將在 1 小時後失效。</strong></p>
        
        <p>如果您沒有申請密碼重設，請忽略此郵件。</p>
        
        <hr style="border: none; border-top: 1px solid #eee; margin: 20px 0;">
        
        <p style="color: #999; font-size: 12px;">
            此郵件由系統自動發送，請勿直接回覆。<br>
            鴻展盟管理系統
        </p>
    </div>
</body>
</html>
HTML;
    }
    
    /**
     * 記錄郵件發送
     */
    protected function logMail($to, $subject, $success)
    {
        $logPath = ROOT_PATH . '/storage/logs/mail.log';
        $status = $success ? 'SUCCESS' : 'FAILED';
        $log = sprintf(
            "[%s] %s | To: %s | Subject: %s\n",
            date('Y-m-d H:i:s'),
            $status,
            $to,
            $subject
        );
        
        file_put_contents($logPath, $log, FILE_APPEND);
    }
}
```

---

## 郵件設定

**檔案位置**: `config/mail.php`

```php
<?php
return [
    'from_email' => 'noreply@your-domain.com',
    'from_name' => '鴻展盟管理系統',
    
    // 如果使用 SMTP (需要額外安裝 PHPMailer 或類似套件)
    'smtp' => [
        'host' => 'smtp.example.com',
        'port' => 587,
        'username' => 'your-username',
        'password' => 'your-password',
        'encryption' => 'tls'
    ]
];
```

---

## 密碼相關控制器

### AccountController (擴充)

在 `AccountController.php` 中新增：

```php
/**
 * 忘記密碼頁面
 * 網址: /account/forgot-password
 */
public function forgotPassword()
{
    // 處理 POST 請求
    if ($_SERVER['REQUEST_METHOD'] === 'POST') {
        $email = trim($_POST['email'] ?? '');
        
        // 驗證 CSRF Token
        if (!$this->validateCsrfToken($_POST['_token'] ?? '')) {
            $this->render('account/forgot-password', [
                'error' => '表單已過期，請重新整理',
                'csrf_token' => $this->generateCsrfToken()
            ]);
            return;
        }
        
        if (empty($email)) {
            $this->render('account/forgot-password', [
                'error' => '請輸入 Email',
                'csrf_token' => $this->generateCsrfToken()
            ]);
            return;
        }
        
        $passwordService = new \App\Services\PasswordService();
        $result = $passwordService->sendResetLink($email);
        
        $this->render('account/forgot-password', [
            'success' => $result['message'],
            'csrf_token' => $this->generateCsrfToken()
        ]);
        return;
    }
    
    // 顯示忘記密碼頁面
    $this->render('account/forgot-password', [
        'csrf_token' => $this->generateCsrfToken()
    ]);
}

/**
 * 重設密碼頁面
 * 網址: /account/reset-password
 */
public function resetPassword()
{
    $token = $_GET['token'] ?? '';
    $email = $_GET['email'] ?? '';
    
    $passwordService = new \App\Services\PasswordService();
    
    // 驗證 Token
    $validation = $passwordService->validateResetToken($email, $token);
    
    if (!$validation['valid']) {
        $this->render('account/reset-password', [
            'error' => $validation['message'],
            'valid' => false
        ]);
        return;
    }
    
    // 處理 POST 請求
    if ($_SERVER['REQUEST_METHOD'] === 'POST') {
        $newPassword = $_POST['password'] ?? '';
        $confirmPassword = $_POST['password_confirmation'] ?? '';
        
        // 驗證 CSRF Token
        if (!$this->validateCsrfToken($_POST['_token'] ?? '')) {
            $this->render('account/reset-password', [
                'error' => '表單已過期，請重新整理',
                'valid' => true,
                'token' => $token,
                'email' => $email,
                'csrf_token' => $this->generateCsrfToken()
            ]);
            return;
        }
        
        // 確認密碼
        if ($newPassword !== $confirmPassword) {
            $this->render('account/reset-password', [
                'error' => '兩次輸入的密碼不一致',
                'valid' => true,
                'token' => $token,
                'email' => $email,
                'csrf_token' => $this->generateCsrfToken()
            ]);
            return;
        }
        
        // 重設密碼
        $result = $passwordService->resetPassword($email, $token, $newPassword);
        
        if ($result['success']) {
            $this->redirect('/account/login?reset=1');
        } else {
            $this->render('account/reset-password', [
                'error' => $result['message'],
                'valid' => true,
                'token' => $token,
                'email' => $email,
                'csrf_token' => $this->generateCsrfToken()
            ]);
        }
        return;
    }
    
    // 顯示重設密碼表單
    $this->render('account/reset-password', [
        'valid' => true,
        'token' => $token,
        'email' => $email,
        'csrf_token' => $this->generateCsrfToken()
    ]);
}

/**
 * 修改密碼頁面 (需登入)
 * 網址: /account/change-password
 */
public function changePassword()
{
    // 檢查登入
    if (!$this->isLoggedIn()) {
        $this->redirect('/account/login');
    }
    
    // 處理 POST 請求
    if ($_SERVER['REQUEST_METHOD'] === 'POST') {
        $currentPassword = $_POST['current_password'] ?? '';
        $newPassword = $_POST['new_password'] ?? '';
        $confirmPassword = $_POST['password_confirmation'] ?? '';
        
        // 驗證 CSRF Token
        if (!$this->validateCsrfToken($_POST['_token'] ?? '')) {
            $this->render('account/change-password', [
                'error' => '表單已過期，請重新整理',
                'csrf_token' => $this->generateCsrfToken()
            ], 'backend');
            return;
        }
        
        // 確認密碼
        if ($newPassword !== $confirmPassword) {
            $this->render('account/change-password', [
                'error' => '兩次輸入的密碼不一致',
                'csrf_token' => $this->generateCsrfToken()
            ], 'backend');
            return;
        }
        
        $passwordService = new \App\Services\PasswordService();
        $result = $passwordService->changePassword(
            $this->currentUser()['id'],
            $currentPassword,
            $newPassword
        );
        
        if ($result['success']) {
            $this->render('account/change-password', [
                'success' => $result['message'],
                'csrf_token' => $this->generateCsrfToken()
            ], 'backend');
        } else {
            $this->render('account/change-password', [
                'error' => $result['message'],
                'csrf_token' => $this->generateCsrfToken()
            ], 'backend');
        }
        return;
    }
    
    // 顯示修改密碼頁面
    $this->render('account/change-password', [
        'csrf_token' => $this->generateCsrfToken()
    ], 'backend');
}
```

---

## 密碼相關視圖

### forgot-password.php

**檔案位置**: `app/Views/account/forgot-password.php`

```php
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>忘記密碼 - 鴻展盟管理系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .card {
            max-width: 400px;
            width: 100%;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="card">
        <h4 class="mb-4">忘記密碼</h4>
        
        <?php if (!empty($success)): ?>
        <div class="alert alert-success"><?= htmlspecialchars($success) ?></div>
        <?php endif; ?>
        
        <?php if (!empty($error)): ?>
        <div class="alert alert-danger"><?= htmlspecialchars($error) ?></div>
        <?php endif; ?>
        
        <p class="text-muted">請輸入您註冊時使用的 Email，我們將寄送密碼重設連結給您。</p>
        
        <form method="POST">
            <input type="hidden" name="_token" value="<?= $csrf_token ?? '' ?>">
            
            <div class="mb-3">
                <label class="form-label">Email</label>
                <input type="email" name="email" class="form-control" required>
            </div>
            
            <button type="submit" class="btn btn-primary w-100 mb-3">發送重設連結</button>
            
            <div class="text-center">
                <a href="/account/login">返回登入</a>
            </div>
        </form>
    </div>
</body>
</html>
```

### reset-password.php

**檔案位置**: `app/Views/account/reset-password.php`

```php
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>重設密碼 - 鴻展盟管理系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .card {
            max-width: 400px;
            width: 100%;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="card">
        <h4 class="mb-4">重設密碼</h4>
        
        <?php if (!empty($error)): ?>
        <div class="alert alert-danger"><?= htmlspecialchars($error) ?></div>
        <?php endif; ?>
        
        <?php if (empty($valid)): ?>
        <p>此連結無效或已過期。</p>
        <a href="/account/forgot-password" class="btn btn-primary">重新申請</a>
        <?php else: ?>
        
        <form method="POST">
            <input type="hidden" name="_token" value="<?= $csrf_token ?? '' ?>">
            
            <div class="mb-3">
                <label class="form-label">新密碼</label>
                <input type="password" name="password" class="form-control" required minlength="8">
                <small class="text-muted">至少 8 個字元，需包含英文字母和數字</small>
            </div>
            
            <div class="mb-3">
                <label class="form-label">確認新密碼</label>
                <input type="password" name="password_confirmation" class="form-control" required>
            </div>
            
            <button type="submit" class="btn btn-primary w-100">重設密碼</button>
        </form>
        <?php endif; ?>
    </div>
</body>
</html>
```
