# 操作紀錄系統

## 系統概述

操作紀錄系統用於記錄所有使用者在系統中的操作行為，包含：
- 頁面瀏覽
- 資料新增、修改、刪除
- 系統設定變更
- 其他重要操作

---

## 操作紀錄過濾器

### RecordActionFilter

**檔案位置**: `app/Filters/RecordActionFilter.php`

```php
<?php
namespace App\Filters;

use App\Models\ActionLog;

/**
 * 操作紀錄過濾器
 * 
 * 用於記錄 Controller 的所有操作
 * 相當於 .NET 的 ActionFilterAttribute
 */
class RecordActionFilter
{
    protected $actionLogModel;
    
    /**
     * 不記錄的控制器/方法
     */
    protected $excludeActions = [
        'AccountController' => ['login', 'logout', 'refreshSession'],
        'ApiController' => ['healthCheck'],
    ];
    
    /**
     * 敏感欄位 (不記錄內容)
     */
    protected $sensitiveFields = [
        'password',
        'password_confirmation',
        'current_password',
        'new_password',
        'credit_card',
        'cvv',
        'token'
    ];
    
    public function __construct()
    {
        $this->actionLogModel = new ActionLog();
    }
    
    /**
     * 記錄操作
     * 
     * @param string $controller 控制器名稱
     * @param string $method 方法名稱
     * @param string|null $description 操作描述
     */
    public function record($controller, $method, $description = null)
    {
        // 取得控制器簡短名稱
        $controllerName = $this->getShortControllerName($controller);
        
        // 檢查是否排除
        if ($this->isExcluded($controllerName, $method)) {
            return;
        }
        
        // 判斷操作類型
        $action = $this->determineAction($method);
        
        // 取得請求資料
        $requestData = $this->getFilteredRequestData();
        
        // 建立紀錄
        $data = [
            'user_id' => $_SESSION['user']['id'] ?? null,
            'username' => $_SESSION['user']['username'] ?? null,
            'action' => $action,
            'controller' => $controllerName,
            'method' => $method,
            'url' => $_SERVER['REQUEST_URI'] ?? '',
            'http_method' => $_SERVER['REQUEST_METHOD'] ?? 'GET',
            'ip_address' => $this->getClientIp(),
            'user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? null,
            'request_data' => !empty($requestData) ? json_encode($requestData, JSON_UNESCAPED_UNICODE) : null,
            'description' => $description
        ];
        
        $this->actionLogModel->create($data);
    }
    
    /**
     * 記錄自訂操作
     */
    public function recordCustom($action, $description, $extraData = [])
    {
        $data = [
            'user_id' => $_SESSION['user']['id'] ?? null,
            'username' => $_SESSION['user']['username'] ?? null,
            'action' => $action,
            'controller' => $extraData['controller'] ?? 'Custom',
            'method' => $extraData['method'] ?? 'custom',
            'url' => $_SERVER['REQUEST_URI'] ?? '',
            'http_method' => $_SERVER['REQUEST_METHOD'] ?? 'GET',
            'ip_address' => $this->getClientIp(),
            'user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? null,
            'request_data' => !empty($extraData) ? json_encode($extraData, JSON_UNESCAPED_UNICODE) : null,
            'description' => $description
        ];
        
        $this->actionLogModel->create($data);
    }
    
    /**
     * 取得控制器簡短名稱
     */
    protected function getShortControllerName($controller)
    {
        // 移除命名空間前綴
        $parts = explode('\\', $controller);
        return end($parts);
    }
    
    /**
     * 判斷操作類型
     */
    protected function determineAction($method)
    {
        $method = strtolower($method);
        
        // 檢視操作
        if (in_array($method, ['index', 'show', 'view', 'list', 'get', 'detail'])) {
            return 'view';
        }
        
        // 新增操作
        if (in_array($method, ['create', 'store', 'add', 'insert'])) {
            return 'create';
        }
        
        // 編輯操作
        if (in_array($method, ['edit', 'update', 'modify', 'save'])) {
            return 'update';
        }
        
        // 刪除操作
        if (in_array($method, ['delete', 'destroy', 'remove'])) {
            return 'delete';
        }
        
        // 其他操作
        return 'other';
    }
    
    /**
     * 檢查是否排除記錄
     */
    protected function isExcluded($controller, $method)
    {
        if (isset($this->excludeActions[$controller])) {
            return in_array($method, $this->excludeActions[$controller]);
        }
        
        return false;
    }
    
    /**
     * 取得過濾後的請求資料
     */
    protected function getFilteredRequestData()
    {
        $data = [];
        
        // GET 參數
        if (!empty($_GET)) {
            $data['query'] = $this->filterSensitive($_GET);
        }
        
        // POST 參數
        if (!empty($_POST)) {
            $data['body'] = $this->filterSensitive($_POST);
        }
        
        // JSON 請求
        $input = file_get_contents('php://input');
        if ($input && $this->isJson($input)) {
            $jsonData = json_decode($input, true);
            if ($jsonData) {
                $data['json'] = $this->filterSensitive($jsonData);
            }
        }
        
        return $data;
    }
    
    /**
     * 過濾敏感欄位
     */
    protected function filterSensitive(array $data)
    {
        foreach ($data as $key => $value) {
            if (in_array(strtolower($key), $this->sensitiveFields)) {
                $data[$key] = '***FILTERED***';
            } elseif (is_array($value)) {
                $data[$key] = $this->filterSensitive($value);
            }
        }
        
        return $data;
    }
    
    /**
     * 判斷是否為 JSON
     */
    protected function isJson($string)
    {
        json_decode($string);
        return json_last_error() === JSON_ERROR_NONE;
    }
    
    /**
     * 取得客戶端 IP
     */
    protected function getClientIp()
    {
        $headers = [
            'HTTP_CF_CONNECTING_IP',     // Cloudflare
            'HTTP_X_FORWARDED_FOR',
            'HTTP_X_FORWARDED',
            'HTTP_X_CLUSTER_CLIENT_IP',
            'HTTP_FORWARDED_FOR',
            'HTTP_FORWARDED',
            'REMOTE_ADDR'
        ];
        
        foreach ($headers as $header) {
            if (!empty($_SERVER[$header])) {
                $ips = explode(',', $_SERVER[$header]);
                $ip = trim($ips[0]);
                
                if (filter_var($ip, FILTER_VALIDATE_IP)) {
                    return $ip;
                }
            }
        }
        
        return '0.0.0.0';
    }
}
```

---

## 操作紀錄模型

### ActionLog Model

**檔案位置**: `app/Models/ActionLog.php`

```php
<?php
namespace App\Models;

use Core\Model;

class ActionLog extends Model
{
    protected $table = 'ActionLogs';
    protected $fillable = [
        'user_id',
        'username',
        'action',
        'controller',
        'method',
        'url',
        'http_method',
        'ip_address',
        'user_agent',
        'request_data',
        'response_code',
        'description'
    ];
    
    /**
     * 依使用者查詢
     */
    public function getByUser($userId, $limit = 100)
    {
        $sql = "SELECT * FROM {$this->table} 
                WHERE user_id = :user_id 
                ORDER BY created_at DESC 
                LIMIT :limit";
        
        $stmt = $this->db->getPdo()->prepare($sql);
        $stmt->bindValue(':user_id', $userId, \PDO::PARAM_INT);
        $stmt->bindValue(':limit', $limit, \PDO::PARAM_INT);
        $stmt->execute();
        
        return $stmt->fetchAll();
    }
    
    /**
     * 依日期範圍查詢
     */
    public function getByDateRange($startDate, $endDate, $userId = null)
    {
        $sql = "SELECT * FROM {$this->table} 
                WHERE created_at BETWEEN :start_date AND :end_date";
        
        $params = [
            'start_date' => $startDate . ' 00:00:00',
            'end_date' => $endDate . ' 23:59:59'
        ];
        
        if ($userId) {
            $sql .= " AND user_id = :user_id";
            $params['user_id'] = $userId;
        }
        
        $sql .= " ORDER BY created_at DESC";
        
        return $this->db->query($sql, $params)->fetchAll();
    }
    
    /**
     * 依控制器查詢
     */
    public function getByController($controller, $limit = 100)
    {
        $sql = "SELECT * FROM {$this->table} 
                WHERE controller = :controller 
                ORDER BY created_at DESC 
                LIMIT :limit";
        
        $stmt = $this->db->getPdo()->prepare($sql);
        $stmt->bindValue(':controller', $controller, \PDO::PARAM_STR);
        $stmt->bindValue(':limit', $limit, \PDO::PARAM_INT);
        $stmt->execute();
        
        return $stmt->fetchAll();
    }
    
    /**
     * 分頁查詢 (含搜尋)
     */
    public function search($filters = [], $page = 1, $perPage = 20)
    {
        $where = ['1=1'];
        $params = [];
        
        if (!empty($filters['user_id'])) {
            $where[] = 'user_id = :user_id';
            $params['user_id'] = $filters['user_id'];
        }
        
        if (!empty($filters['action'])) {
            $where[] = 'action = :action';
            $params['action'] = $filters['action'];
        }
        
        if (!empty($filters['controller'])) {
            $where[] = 'controller LIKE :controller';
            $params['controller'] = '%' . $filters['controller'] . '%';
        }
        
        if (!empty($filters['start_date'])) {
            $where[] = 'created_at >= :start_date';
            $params['start_date'] = $filters['start_date'] . ' 00:00:00';
        }
        
        if (!empty($filters['end_date'])) {
            $where[] = 'created_at <= :end_date';
            $params['end_date'] = $filters['end_date'] . ' 23:59:59';
        }
        
        if (!empty($filters['ip_address'])) {
            $where[] = 'ip_address = :ip_address';
            $params['ip_address'] = $filters['ip_address'];
        }
        
        $whereClause = implode(' AND ', $where);
        
        // 計算總數
        $countSql = "SELECT COUNT(*) as total FROM {$this->table} WHERE {$whereClause}";
        $total = $this->db->query($countSql, $params)->fetch()['total'];
        
        // 查詢資料
        $offset = ($page - 1) * $perPage;
        $sql = "SELECT * FROM {$this->table} 
                WHERE {$whereClause} 
                ORDER BY created_at DESC 
                LIMIT {$perPage} OFFSET {$offset}";
        
        $data = $this->db->query($sql, $params)->fetchAll();
        
        return [
            'data' => $data,
            'total' => $total,
            'per_page' => $perPage,
            'current_page' => $page,
            'last_page' => ceil($total / $perPage)
        ];
    }
    
    /**
     * 清除舊紀錄
     */
    public function cleanOldLogs($days = 90)
    {
        $sql = "DELETE FROM {$this->table} 
                WHERE created_at < DATE_SUB(NOW(), INTERVAL :days DAY)";
        
        return $this->db->query($sql, ['days' => $days]);
    }
    
    /**
     * 統計操作次數
     */
    public function getStatistics($startDate = null, $endDate = null)
    {
        $where = [];
        $params = [];
        
        if ($startDate) {
            $where[] = 'created_at >= :start_date';
            $params['start_date'] = $startDate;
        }
        
        if ($endDate) {
            $where[] = 'created_at <= :end_date';
            $params['end_date'] = $endDate;
        }
        
        $whereClause = !empty($where) ? 'WHERE ' . implode(' AND ', $where) : '';
        
        $sql = "SELECT 
                    action,
                    COUNT(*) as count,
                    DATE(created_at) as date
                FROM {$this->table}
                {$whereClause}
                GROUP BY action, DATE(created_at)
                ORDER BY date DESC, action";
        
        return $this->db->query($sql, $params)->fetchAll();
    }
}
```

---

## 操作紀錄控制器

### ActionLogController

**檔案位置**: `app/Controllers/Backend/ActionLogController.php`

```php
<?php
namespace App\Controllers\Backend;

use Core\Controller;
use App\Models\ActionLog;
use App\Models\User;

class ActionLogController extends Controller
{
    protected $actionLogModel;
    protected $userModel;
    
    public function __construct()
    {
        parent::__construct();
        
        $this->actionLogModel = new ActionLog();
        $this->userModel = new User();
    }
    
    /**
     * 操作紀錄列表
     */
    public function index()
    {
        // 搜尋條件
        $filters = [
            'user_id' => $_GET['user_id'] ?? null,
            'action' => $_GET['action'] ?? null,
            'controller' => $_GET['controller'] ?? null,
            'start_date' => $_GET['start_date'] ?? null,
            'end_date' => $_GET['end_date'] ?? null,
            'ip_address' => $_GET['ip_address'] ?? null,
        ];
        
        $page = (int) ($_GET['page'] ?? 1);
        
        // 取得紀錄
        $logs = $this->actionLogModel->search($filters, $page, 50);
        
        // 取得使用者列表 (用於篩選)
        $users = $this->userModel->all(['id', 'username', 'display_name']);
        
        // 操作類型
        $actions = [
            'view' => '檢視',
            'create' => '新增',
            'update' => '修改',
            'delete' => '刪除',
            'other' => '其他'
        ];
        
        $this->render('backend/action-logs/index', [
            'logs' => $logs,
            'users' => $users,
            'actions' => $actions,
            'filters' => $filters,
            'page_title' => '操作紀錄'
        ], 'backend');
    }
    
    /**
     * 檢視紀錄詳情
     */
    public function show($id)
    {
        $log = $this->actionLogModel->find($id);
        
        if (!$log) {
            $this->redirect('/admin/action-logs');
        }
        
        // 解析 request_data
        if ($log['request_data']) {
            $log['request_data_parsed'] = json_decode($log['request_data'], true);
        }
        
        $this->render('backend/action-logs/show', [
            'log' => $log,
            'page_title' => '操作紀錄詳情'
        ], 'backend');
    }
    
    /**
     * 匯出紀錄
     */
    public function export()
    {
        // 搜尋條件
        $filters = [
            'user_id' => $_GET['user_id'] ?? null,
            'action' => $_GET['action'] ?? null,
            'start_date' => $_GET['start_date'] ?? null,
            'end_date' => $_GET['end_date'] ?? null,
        ];
        
        $logs = $this->actionLogModel->search($filters, 1, 10000);
        
        // 設定 CSV 下載
        header('Content-Type: text/csv; charset=utf-8');
        header('Content-Disposition: attachment; filename=action_logs_' . date('Ymd_His') . '.csv');
        
        $output = fopen('php://output', 'w');
        
        // BOM for UTF-8
        fprintf($output, chr(0xEF).chr(0xBB).chr(0xBF));
        
        // 標題列
        fputcsv($output, ['ID', '使用者', '操作類型', '控制器', '方法', '網址', 'IP', '時間']);
        
        // 資料列
        foreach ($logs['data'] as $log) {
            fputcsv($output, [
                $log['id'],
                $log['username'],
                $log['action'],
                $log['controller'],
                $log['method'],
                $log['url'],
                $log['ip_address'],
                $log['created_at']
            ]);
        }
        
        fclose($output);
        exit;
    }
}
```

---

## 如何使用

### 1. 自動記錄 (推薦)

只要繼承 `Core\Controller`，所有操作都會自動記錄。

```php
<?php
namespace App\Controllers\Backend;

use Core\Controller;

class UserController extends Controller
{
    // 所有方法的操作都會自動記錄
    public function index()
    {
        // ...
    }
    
    public function create()
    {
        // ...
    }
}
```

### 2. 手動記錄自訂操作

```php
<?php
use App\Filters\RecordActionFilter;

$filter = new RecordActionFilter();

// 記錄自訂操作
$filter->recordCustom('export', '匯出使用者資料', [
    'format' => 'csv',
    'count' => 100
]);
```

### 3. 排除特定操作

修改 `RecordActionFilter` 的 `$excludeActions` 陣列：

```php
protected $excludeActions = [
    'AccountController' => ['login', 'logout', 'refreshSession'],
    'ApiController' => ['healthCheck'],
    // 新增排除項目
    'ReportController' => ['preview'],
];
```
