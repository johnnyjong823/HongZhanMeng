# 登入驗證系統

## 系統概述

登入驗證系統負責：
- 使用者登入/登出
- Session 管理 (60 分鐘逾時)
- 登入紀錄
- 登入失敗鎖定

---

## Session 管理

### Session 設定

**檔案位置**: `config/app.php`

```php
<?php
return [
    'name' => '鴻展盟管理系統',
    'debug' => false,
    'url' => 'https://your-domain.com',
    
    // Session 設定
    'session' => [
        'lifetime' => 3600,       // 60 分鐘 (秒)
        'path' => '/',
        'domain' => null,
        'secure' => true,         // HTTPS only
        'httponly' => true,       // 禁止 JavaScript 存取
        'samesite' => 'Lax',
    ],
    
    // 登入設定
    'auth' => [
        'max_attempts' => 5,           // 最大嘗試次數
        'lockout_time' => 900,         // 鎖定時間 (15 分鐘)
        'password_min_length' => 8,    // 密碼最小長度
    ],
];
```

---

## 登入紀錄模型

### LoginLog Model

**檔案位置**: `app/Models/LoginLog.php`

```php
<?php
namespace App\Models;

use Core\Model;

class LoginLog extends Model
{
    protected $table = 'LoginLogs';
    protected $fillable = [
        'user_id',
        'username',
        'ip_address',
        'user_agent',
        'login_status',
        'failure_reason',
        'session_id'
    ];
    
    /**
     * 記錄登入成功
     */
    public function recordSuccess($userId, $username)
    {
        return $this->create([
            'user_id' => $userId,
            'username' => $username,
            'ip_address' => $this->getClientIp(),
            'user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? null,
            'login_status' => 1,
            'session_id' => session_id()
        ]);
    }
    
    /**
     * 記錄登入失敗
     */
    public function recordFailure($username, $reason = null)
    {
        return $this->create([
            'user_id' => null,
            'username' => $username,
            'ip_address' => $this->getClientIp(),
            'user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? null,
            'login_status' => 0,
            'failure_reason' => $reason
        ]);
    }
    
    /**
     * 記錄登出
     */
    public function recordLogout($userId)
    {
        $sessionId = session_id();
        
        $sql = "UPDATE {$this->table} 
                SET logout_at = NOW() 
                WHERE user_id = :user_id 
                  AND session_id = :session_id 
                  AND logout_at IS NULL
                ORDER BY login_at DESC 
                LIMIT 1";
        
        return $this->db->query($sql, [
            'user_id' => $userId,
            'session_id' => $sessionId
        ]);
    }
    
    /**
     * 取得使用者登入紀錄
     */
    public function getUserLogs($userId, $limit = 50)
    {
        $sql = "SELECT * FROM {$this->table} 
                WHERE user_id = :user_id 
                ORDER BY login_at DESC 
                LIMIT :limit";
        
        $stmt = $this->db->getPdo()->prepare($sql);
        $stmt->bindValue(':user_id', $userId, \PDO::PARAM_INT);
        $stmt->bindValue(':limit', $limit, \PDO::PARAM_INT);
        $stmt->execute();
        
        return $stmt->fetchAll();
    }
    
    /**
     * 取得最近的失敗登入次數
     */
    public function getRecentFailures($username, $minutes = 15)
    {
        $sql = "SELECT COUNT(*) as count FROM {$this->table} 
                WHERE username = :username 
                  AND login_status = 0 
                  AND login_at > DATE_SUB(NOW(), INTERVAL :minutes MINUTE)";
        
        $result = $this->db->query($sql, [
            'username' => $username,
            'minutes' => $minutes
        ])->fetch();
        
        return $result['count'];
    }
    
    /**
     * 檢查 IP 是否被暫時封鎖
     */
    public function isIpBlocked($ip, $maxAttempts = 10, $minutes = 30)
    {
        $sql = "SELECT COUNT(*) as count FROM {$this->table} 
                WHERE ip_address = :ip 
                  AND login_status = 0 
                  AND login_at > DATE_SUB(NOW(), INTERVAL :minutes MINUTE)";
        
        $result = $this->db->query($sql, [
            'ip' => $ip,
            'minutes' => $minutes
        ])->fetch();
        
        return $result['count'] >= $maxAttempts;
    }
    
    /**
     * 取得客戶端 IP
     */
    protected function getClientIp()
    {
        $headers = [
            'HTTP_CF_CONNECTING_IP',
            'HTTP_X_FORWARDED_FOR',
            'HTTP_X_FORWARDED',
            'REMOTE_ADDR'
        ];
        
        foreach ($headers as $header) {
            if (!empty($_SERVER[$header])) {
                $ips = explode(',', $_SERVER[$header]);
                $ip = trim($ips[0]);
                
                if (filter_var($ip, FILTER_VALIDATE_IP)) {
                    return $ip;
                }
            }
        }
        
        return '0.0.0.0';
    }
    
    /**
     * 分頁查詢登入紀錄
     */
    public function search($filters = [], $page = 1, $perPage = 50)
    {
        $where = ['1=1'];
        $params = [];
        
        if (!empty($filters['user_id'])) {
            $where[] = 'user_id = :user_id';
            $params['user_id'] = $filters['user_id'];
        }
        
        if (!empty($filters['username'])) {
            $where[] = 'username LIKE :username';
            $params['username'] = '%' . $filters['username'] . '%';
        }
        
        if (isset($filters['login_status']) && $filters['login_status'] !== '') {
            $where[] = 'login_status = :login_status';
            $params['login_status'] = $filters['login_status'];
        }
        
        if (!empty($filters['ip_address'])) {
            $where[] = 'ip_address = :ip_address';
            $params['ip_address'] = $filters['ip_address'];
        }
        
        if (!empty($filters['start_date'])) {
            $where[] = 'login_at >= :start_date';
            $params['start_date'] = $filters['start_date'] . ' 00:00:00';
        }
        
        if (!empty($filters['end_date'])) {
            $where[] = 'login_at <= :end_date';
            $params['end_date'] = $filters['end_date'] . ' 23:59:59';
        }
        
        $whereClause = implode(' AND ', $where);
        
        // 計算總數
        $countSql = "SELECT COUNT(*) as total FROM {$this->table} WHERE {$whereClause}";
        $total = $this->db->query($countSql, $params)->fetch()['total'];
        
        // 查詢資料
        $offset = ($page - 1) * $perPage;
        $sql = "SELECT * FROM {$this->table} 
                WHERE {$whereClause} 
                ORDER BY login_at DESC 
                LIMIT {$perPage} OFFSET {$offset}";
        
        $data = $this->db->query($sql, $params)->fetchAll();
        
        return [
            'data' => $data,
            'total' => $total,
            'per_page' => $perPage,
            'current_page' => $page,
            'last_page' => ceil($total / $perPage)
        ];
    }
}
```

---

## 認證服務

### AuthService

**檔案位置**: `app/Services/AuthService.php`

```php
<?php
namespace App\Services;

use App\Models\User;
use App\Models\LoginLog;
use App\Services\PermissionService;

class AuthService
{
    protected $userModel;
    protected $loginLogModel;
    protected $permissionService;
    protected $config;
    
    public function __construct()
    {
        $this->userModel = new User();
        $this->loginLogModel = new LoginLog();
        $this->permissionService = new PermissionService();
        $this->config = require ROOT_PATH . '/config/app.php';
    }
    
    /**
     * 登入
     * 
     * @param string $username 帳號或 Email
     * @param string $password 密碼
     * @param bool $remember 記住我
     * @return array ['success' => bool, 'message' => string, 'user' => array|null]
     */
    public function login($username, $password, $remember = false)
    {
        // 檢查 IP 是否被封鎖
        $ip = $this->getClientIp();
        if ($this->loginLogModel->isIpBlocked($ip)) {
            return [
                'success' => false,
                'message' => '此 IP 因多次登入失敗已被暫時封鎖，請稍後再試'
            ];
        }
        
        // 查詢使用者 (支援帳號或 Email 登入)
        $user = $this->userModel->findByUsername($username);
        
        if (!$user) {
            $user = $this->userModel->findByEmail($username);
        }
        
        // 使用者不存在
        if (!$user) {
            $this->loginLogModel->recordFailure($username, '帳號不存在');
            return [
                'success' => false,
                'message' => '帳號或密碼錯誤'
            ];
        }
        
        // 檢查帳號狀態
        if ($user['status'] != 1) {
            $this->loginLogModel->recordFailure($username, '帳號已停用');
            return [
                'success' => false,
                'message' => '此帳號已被停用'
            ];
        }
        
        // 檢查是否被鎖定
        if ($user['locked_until'] && strtotime($user['locked_until']) > time()) {
            $this->loginLogModel->recordFailure($username, '帳號已鎖定');
            $remainingTime = ceil((strtotime($user['locked_until']) - time()) / 60);
            return [
                'success' => false,
                'message' => "帳號已鎖定，請 {$remainingTime} 分鐘後再試"
            ];
        }
        
        // 驗證密碼
        if (!password_verify($password, $user['password'])) {
            // 記錄失敗
            $this->loginLogModel->recordFailure($username, '密碼錯誤');
            
            // 增加失敗次數
            $attempts = $user['login_attempts'] + 1;
            $maxAttempts = $this->config['auth']['max_attempts'] ?? 5;
            
            $updateData = ['login_attempts' => $attempts];
            
            // 超過次數則鎖定帳號
            if ($attempts >= $maxAttempts) {
                $lockoutTime = $this->config['auth']['lockout_time'] ?? 900;
                $updateData['locked_until'] = date('Y-m-d H:i:s', time() + $lockoutTime);
            }
            
            $this->userModel->update($user['id'], $updateData);
            
            $remaining = $maxAttempts - $attempts;
            if ($remaining > 0) {
                return [
                    'success' => false,
                    'message' => "帳號或密碼錯誤，還有 {$remaining} 次嘗試機會"
                ];
            } else {
                return [
                    'success' => false,
                    'message' => '登入失敗次數過多，帳號已被暫時鎖定'
                ];
            }
        }
        
        // 登入成功
        // 重設失敗次數
        $this->userModel->update($user['id'], [
            'login_attempts' => 0,
            'locked_until' => null,
            'last_login_at' => date('Y-m-d H:i:s'),
            'last_login_ip' => $ip
        ]);
        
        // 記錄登入紀錄
        $this->loginLogModel->recordSuccess($user['id'], $user['username']);
        
        // 重新產生 Session ID (防止 Session Fixation)
        session_regenerate_id(true);
        
        // 設定 Session
        $_SESSION['user'] = [
            'id' => $user['id'],
            'username' => $user['username'],
            'email' => $user['email'],
            'display_name' => $user['display_name'],
            'avatar' => $user['avatar'],
            'status' => $user['status']
        ];
        
        $_SESSION['last_activity'] = time();
        
        // 載入權限
        $this->permissionService->loadUserPermissions($user['id']);
        
        // 記住我功能
        if ($remember) {
            $this->setRememberToken($user['id']);
        }
        
        return [
            'success' => true,
            'message' => '登入成功',
            'user' => $_SESSION['user']
        ];
    }
    
    /**
     * 登出
     */
    public function logout()
    {
        $userId = $_SESSION['user']['id'] ?? null;
        
        // 記錄登出
        if ($userId) {
            $this->loginLogModel->recordLogout($userId);
            
            // 清除記住我 Token
            $this->clearRememberToken($userId);
        }
        
        // 清除 Session
        $_SESSION = [];
        
        // 刪除 Session Cookie
        if (ini_get('session.use_cookies')) {
            $params = session_get_cookie_params();
            setcookie(
                session_name(),
                '',
                time() - 42000,
                $params['path'],
                $params['domain'],
                $params['secure'],
                $params['httponly']
            );
        }
        
        // 銷毀 Session
        session_destroy();
        
        return true;
    }
    
    /**
     * 檢查是否已登入
     */
    public function check()
    {
        return isset($_SESSION['user']) && !empty($_SESSION['user']['id']);
    }
    
    /**
     * 取得目前使用者
     */
    public function user()
    {
        return $_SESSION['user'] ?? null;
    }
    
    /**
     * 檢查 Session 是否逾時
     */
    public function checkTimeout()
    {
        $timeout = $this->config['session']['lifetime'] ?? 3600;
        
        if (isset($_SESSION['last_activity'])) {
            if (time() - $_SESSION['last_activity'] > $timeout) {
                $this->logout();
                return true; // 已逾時
            }
        }
        
        // 更新最後活動時間
        $_SESSION['last_activity'] = time();
        
        return false; // 未逾時
    }
    
    /**
     * 設定記住我 Token
     */
    protected function setRememberToken($userId)
    {
        $token = bin2hex(random_bytes(32));
        $hashedToken = hash('sha256', $token);
        
        $this->userModel->update($userId, [
            'remember_token' => $hashedToken
        ]);
        
        // 設定 Cookie (30 天)
        setcookie(
            'remember_token',
            $userId . '|' . $token,
            time() + (30 * 24 * 60 * 60),
            '/',
            '',
            true,    // Secure
            true     // HttpOnly
        );
    }
    
    /**
     * 清除記住我 Token
     */
    protected function clearRememberToken($userId)
    {
        $this->userModel->update($userId, [
            'remember_token' => null
        ]);
        
        setcookie('remember_token', '', time() - 3600, '/');
    }
    
    /**
     * 嘗試使用記住我 Token 登入
     */
    public function attemptRememberLogin()
    {
        if (!isset($_COOKIE['remember_token'])) {
            return false;
        }
        
        $parts = explode('|', $_COOKIE['remember_token']);
        
        if (count($parts) !== 2) {
            return false;
        }
        
        list($userId, $token) = $parts;
        
        $user = $this->userModel->find($userId);
        
        if (!$user || !$user['remember_token']) {
            return false;
        }
        
        if (hash('sha256', $token) !== $user['remember_token']) {
            return false;
        }
        
        if ($user['status'] != 1) {
            return false;
        }
        
        // 自動登入
        session_regenerate_id(true);
        
        $_SESSION['user'] = [
            'id' => $user['id'],
            'username' => $user['username'],
            'email' => $user['email'],
            'display_name' => $user['display_name'],
            'avatar' => $user['avatar'],
            'status' => $user['status']
        ];
        
        $_SESSION['last_activity'] = time();
        
        $this->permissionService->loadUserPermissions($user['id']);
        
        // 更新 Token
        $this->setRememberToken($user['id']);
        
        return true;
    }
    
    /**
     * 取得客戶端 IP
     */
    protected function getClientIp()
    {
        $headers = [
            'HTTP_CF_CONNECTING_IP',
            'HTTP_X_FORWARDED_FOR',
            'REMOTE_ADDR'
        ];
        
        foreach ($headers as $header) {
            if (!empty($_SERVER[$header])) {
                $ips = explode(',', $_SERVER[$header]);
                return trim($ips[0]);
            }
        }
        
        return '0.0.0.0';
    }
}
```

---

## 帳號控制器

### AccountController

**檔案位置**: `app/Controllers/AccountController.php`

```php
<?php
namespace App\Controllers;

use Core\Controller;
use App\Services\AuthService;

class AccountController extends Controller
{
    protected $authService;
    
    public function __construct()
    {
        parent::__construct();
        $this->authService = new AuthService();
    }
    
    /**
     * 登入頁面
     * 網址: /account/login
     */
    public function login()
    {
        // 已登入則導向後台
        if ($this->authService->check()) {
            $this->redirect('/admin/dashboard');
        }
        
        // 嘗試記住我登入
        if ($this->authService->attemptRememberLogin()) {
            $this->redirect('/admin/dashboard');
        }
        
        // 處理 POST 請求
        if ($_SERVER['REQUEST_METHOD'] === 'POST') {
            $username = trim($_POST['username'] ?? '');
            $password = $_POST['password'] ?? '';
            $remember = isset($_POST['remember']);
            
            // 驗證 CSRF Token
            if (!$this->validateCsrfToken($_POST['_token'] ?? '')) {
                $this->render('account/login', [
                    'error' => '表單已過期，請重新整理',
                    'username' => $username
                ]);
                return;
            }
            
            // 驗證輸入
            if (empty($username) || empty($password)) {
                $this->render('account/login', [
                    'error' => '請輸入帳號和密碼',
                    'username' => $username
                ]);
                return;
            }
            
            // 執行登入
            $result = $this->authService->login($username, $password, $remember);
            
            if ($result['success']) {
                // 取得重導向網址
                $redirectUrl = $_SESSION['redirect_url'] ?? '/admin/dashboard';
                unset($_SESSION['redirect_url']);
                
                $this->redirect($redirectUrl);
            } else {
                $this->render('account/login', [
                    'error' => $result['message'],
                    'username' => $username
                ]);
                return;
            }
        }
        
        // 顯示登入頁
        $error = null;
        
        if (isset($_GET['expired'])) {
            $error = '登入已逾時，請重新登入';
        } elseif (isset($_GET['error'])) {
            $error = '帳號已停用，請聯繫管理員';
        }
        
        $this->render('account/login', [
            'error' => $error,
            'csrf_token' => $this->generateCsrfToken()
        ]);
    }
    
    /**
     * 登出
     * 網址: /account/logout
     */
    public function logout()
    {
        $this->authService->logout();
        $this->redirect('/account/login');
    }
    
    /**
     * 產生 CSRF Token
     */
    protected function generateCsrfToken()
    {
        $token = bin2hex(random_bytes(32));
        $_SESSION['csrf_token'] = $token;
        return $token;
    }
    
    /**
     * 驗證 CSRF Token
     */
    protected function validateCsrfToken($token)
    {
        if (empty($_SESSION['csrf_token'])) {
            return false;
        }
        
        return hash_equals($_SESSION['csrf_token'], $token);
    }
}
```

---

## 登入視圖

### login.php

**檔案位置**: `app/Views/account/login.php`

```php
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登入 - 鴻展盟管理系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-card {
            max-width: 400px;
            width: 100%;
            padding: 2rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .login-logo {
            text-align: center;
            margin-bottom: 2rem;
        }
        .login-logo h1 {
            font-size: 1.5rem;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="login-card">
        <div class="login-logo">
            <h1>鴻展盟管理系統</h1>
        </div>
        
        <?php if (!empty($error)): ?>
        <div class="alert alert-danger"><?= htmlspecialchars($error) ?></div>
        <?php endif; ?>
        
        <form method="POST" action="/account/login">
            <input type="hidden" name="_token" value="<?= $csrf_token ?? '' ?>">
            
            <div class="mb-3">
                <label class="form-label">帳號或 Email</label>
                <input type="text" name="username" class="form-control" 
                       value="<?= htmlspecialchars($username ?? '') ?>" 
                       required autofocus>
            </div>
            
            <div class="mb-3">
                <label class="form-label">密碼</label>
                <input type="password" name="password" class="form-control" required>
            </div>
            
            <div class="mb-3 form-check">
                <input type="checkbox" name="remember" class="form-check-input" id="remember">
                <label class="form-check-label" for="remember">記住我</label>
            </div>
            
            <button type="submit" class="btn btn-primary w-100 mb-3">登入</button>
            
            <div class="text-center">
                <a href="/account/forgot-password">忘記密碼?</a>
            </div>
        </form>
    </div>
</body>
</html>
```
